24-09-03.20:13:39.755 [main            ] INFO  Application            - Starting Application using Java 1.8.0_171 on LAPTOP-6UTBSJGB with PID 22388 (C:\Users\27132\Java\big-market\big-market-app\target\classes started by 27132 in C:\Users\27132\Java\big-market)
24-09-03.20:13:39.758 [main            ] INFO  Application            - The following 1 profile is active: "dev"
24-09-03.20:13:41.021 [main            ] INFO  RepositoryConfigurationDelegate - Multiple Spring Data modules found, entering strict repository configuration mode
24-09-03.20:13:41.023 [main            ] INFO  RepositoryConfigurationDelegate - Bootstrapping Spring Data Redis repositories in DEFAULT mode.
24-09-03.20:13:41.082 [main            ] INFO  RepositoryConfigurationDelegate - Finished Spring Data repository scanning in 43 ms. Found 0 Redis repository interfaces.
24-09-03.20:13:41.431 [main            ] INFO  PostProcessorRegistrationDelegate$BeanPostProcessorChecker - Bean 'stringToNoneShardingStrategyConfigurationConverter' of type [org.apache.shardingsphere.spring.boot.converter.StringToNoneShardingStrategyConfigurationConverter] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
24-09-03.20:13:41.446 [main            ] INFO  PostProcessorRegistrationDelegate$BeanPostProcessorChecker - Bean 'spring.shardingsphere-org.apache.shardingsphere.spring.boot.prop.SpringBootPropertiesConfiguration' of type [org.apache.shardingsphere.spring.boot.prop.SpringBootPropertiesConfiguration] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
24-09-03.20:13:41.638 [main            ] INFO  PostProcessorRegistrationDelegate$BeanPostProcessorChecker - Bean 'org.apache.shardingsphere.spring.boot.ShardingSphereAutoConfiguration' of type [org.apache.shardingsphere.spring.boot.ShardingSphereAutoConfiguration$$EnhancerBySpringCGLIB$$3fa42fde] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying)
24-09-03.20:13:41.984 [main            ] INFO  TomcatWebServer        - Tomcat initialized with port(s): 8091 (http)
24-09-03.20:13:41.996 [main            ] INFO  Http11NioProtocol      - Initializing ProtocolHandler ["http-nio-8091"]
24-09-03.20:13:41.996 [main            ] INFO  StandardService        - Starting service [Tomcat]
24-09-03.20:13:41.996 [main            ] INFO  StandardEngine         - Starting Servlet engine: [Apache Tomcat/9.0.75]
24-09-03.20:13:42.229 [main            ] INFO  [/]                    - Initializing Spring embedded WebApplicationContext
24-09-03.20:13:42.229 [main            ] INFO  ServletWebServerApplicationContext - Root WebApplicationContext: initialization completed in 2297 ms
24-09-03.20:13:42.519 [main            ] INFO  HikariDataSource       - HikariPool-1 - Starting...
24-09-03.20:13:43.219 [main            ] INFO  HikariDataSource       - HikariPool-1 - Start completed.
24-09-03.20:13:43.235 [main            ] INFO  HikariDataSource       - HikariPool-2 - Starting...
24-09-03.20:13:43.476 [main            ] INFO  HikariDataSource       - HikariPool-2 - Start completed.
24-09-03.20:13:45.519 [main            ] INFO  Version                - Redisson 3.23.4
24-09-03.20:13:46.009 [redisson-netty-2-6] INFO  MasterPubSubConnectionPool - 1 connections initialized for 8.138.41.137/8.138.41.137:16379
24-09-03.20:13:46.183 [redisson-netty-2-13] INFO  MasterConnectionPool   - 5 connections initialized for 8.138.41.137/8.138.41.137:16379
24-09-03.20:13:47.116 [main            ] INFO  StdSchedulerFactory    - Using default implementation for ThreadExecutor
24-09-03.20:13:47.127 [main            ] INFO  SchedulerSignalerImpl  - Initialized Scheduler Signaller of type: class org.quartz.core.SchedulerSignalerImpl
24-09-03.20:13:47.127 [main            ] INFO  QuartzScheduler        - Quartz Scheduler v.2.3.2 created.
24-09-03.20:13:47.128 [main            ] INFO  RAMJobStore            - RAMJobStore initialized.
24-09-03.20:13:47.128 [main            ] INFO  QuartzScheduler        - Scheduler meta-data: Quartz Scheduler (v2.3.2) 'quartzScheduler' with instanceId 'NON_CLUSTERED'
  Scheduler class: 'org.quartz.core.QuartzScheduler' - running locally.
  NOT STARTED.
  Currently in standby mode.
  Number of jobs executed: 0
  Using thread pool 'org.quartz.simpl.SimpleThreadPool' - with 10 threads.
  Using job-store 'org.quartz.simpl.RAMJobStore' - which does not support persistence. and is not clustered.

24-09-03.20:13:47.128 [main            ] INFO  StdSchedulerFactory    - Quartz scheduler 'quartzScheduler' initialized from an externally provided properties instance.
24-09-03.20:13:47.128 [main            ] INFO  StdSchedulerFactory    - Quartz scheduler version: 2.3.2
24-09-03.20:13:47.128 [main            ] INFO  QuartzScheduler        - JobFactory set to: org.springframework.scheduling.quartz.SpringBeanJobFactory@5f0c45ae
24-09-03.20:13:47.418 [main            ] INFO  EndpointLinksResolver  - Exposing 1 endpoint(s) beneath base path '/actuator'
24-09-03.20:13:47.543 [main            ] INFO  Http11NioProtocol      - Starting ProtocolHandler ["http-nio-8091"]
24-09-03.20:13:47.559 [main            ] INFO  TomcatWebServer        - Tomcat started on port(s): 8091 (http) with context path ''
24-09-03.20:13:47.562 [main            ] INFO  CachingConnectionFactory - Attempting to connect to: [8.138.41.137:5672]
24-09-03.20:13:47.683 [main            ] INFO  CachingConnectionFactory - Created new connection: rabbitConnectionFactory#2e778abb:0/SimpleConnection@2728e305 [delegate=amqp://admin@8.138.41.137:5672/, localPort= 49308]
24-09-03.20:13:47.984 [main            ] INFO  SchedulerFactoryBean   - Starting Quartz Scheduler now
24-09-03.20:13:47.985 [main            ] INFO  QuartzScheduler        - Scheduler quartzScheduler_$_NON_CLUSTERED started.
24-09-03.20:13:48.002 [main            ] INFO  Application            - Started Application in 8.755 seconds (JVM running for 9.889)
24-09-03.20:13:48.398 [RMI TCP Connection(1)-172.19.166.193] INFO  [/]                    - Initializing Spring DispatcherServlet 'dispatcherServlet'
24-09-03.20:13:48.398 [RMI TCP Connection(1)-172.19.166.193] INFO  DispatcherServlet      - Initializing Servlet 'dispatcherServlet'
24-09-03.20:13:48.400 [RMI TCP Connection(1)-172.19.166.193] INFO  DispatcherServlet      - Completed initialization in 2 ms
24-09-03.20:13:50.006 [scheduling-1    ] INFO  UpdateActivitySkuStockJob - 定时任务，更新活动sku库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:13:50.039 [scheduling-1    ] INFO  UpdateAwardStockJob    - 定时任务，更新奖品消耗库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:13:50.560 [pool-7-thread-1 ] INFO  ShardingSphere-SQL     - Logic SQL: select topic,
               user_id,
               message,
               message_id
        from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) limit 10;;
24-09-03.20:13:50.560 [pool-7-thread-1 ] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional[org.apache.shardingsphere.sql.parser.sql.common.segment.dml.pagination.limit.LimitSegment@8f4d9aa], lock=Optional.empty, window=Optional.empty)
24-09-03.20:13:50.560 [pool-7-thread-1 ] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:13:50.560 [pool-7-thread-1 ] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:13:55.002 [scheduling-1    ] INFO  UpdateAwardStockJob    - 定时任务，更新奖品消耗库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:13:55.024 [scheduling-1    ] INFO  UpdateActivitySkuStockJob - 定时任务，更新活动sku库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:13:55.055 [pool-7-thread-2 ] INFO  ShardingSphere-SQL     - Logic SQL: select topic,
               user_id,
               message,
               message_id
        from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) limit 10;;
24-09-03.20:13:55.055 [pool-7-thread-2 ] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional[org.apache.shardingsphere.sql.parser.sql.common.segment.dml.pagination.limit.LimitSegment@8f4d9aa], lock=Optional.empty, window=Optional.empty)
24-09-03.20:13:55.055 [pool-7-thread-2 ] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:13:55.055 [pool-7-thread-2 ] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:13:55.086 [http-nio-8091-exec-2] INFO  RaffleActivityController - 活动装配，数据预热，开始 activityId:101
24-09-03.20:13:55.101 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - Logic SQL: select sku,
               activity_id,
               activity_count_id,
               stock_count,
               stock_count_surplus
        from raffle_activity_sku where activity_id = ?;
24-09-03.20:13:55.101 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:13:55.101 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select sku,
               activity_id,
               activity_count_id,
               stock_count,
               stock_count_surplus
        from raffle_activity_sku where activity_id = ?; ::: [101]
24-09-03.20:13:55.251 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - Logic SQL: select id,
               activity_count_id,
               total_count,
               day_count,
               month_count,
               create_time,
               update_time
        from raffle_activity_count where activity_count_id = ?;
24-09-03.20:13:55.251 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:13:55.252 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select id,
               activity_count_id,
               total_count,
               day_count,
               month_count,
               create_time,
               update_time
        from raffle_activity_count where activity_count_id = ?; ::: [101]
24-09-03.20:13:55.345 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - Logic SQL: select id,
               activity_id,
               activity_name,
               activity_desc,
               begin_date_time,
               end_date_time,
               stock_count,
               stock_count_surplus,
               activity_count_id,
               strategy_id,
               `state`,
               create_time,
               update_time
        from raffle_activity where activity_id = ?;
24-09-03.20:13:55.345 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:13:55.345 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select id,
               activity_id,
               activity_name,
               activity_desc,
               begin_date_time,
               end_date_time,
               stock_count,
               stock_count_surplus,
               activity_count_id,
               strategy_id,
               `state`,
               create_time,
               update_time
        from raffle_activity where activity_id = ?; ::: [101]
24-09-03.20:13:55.409 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - Logic SQL: select strategy_id
        from raffle_activity where activity_id = ?;
24-09-03.20:13:55.409 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:13:55.410 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select strategy_id
        from raffle_activity where activity_id = ?; ::: [101]
24-09-03.20:13:55.827 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - Logic SQL: select
            id,
            strategy_id,
            strategy_desc,
            rule_models,
            create_time,
            update_time
        from strategy
        where strategy_id = ?
24-09-03.20:13:55.827 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:13:55.828 [http-nio-8091-exec-2] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select
            id,
            strategy_id,
            strategy_desc,
            rule_models,
            create_time,
            update_time
        from strategy
        where strategy_id = ? ::: [100004]
24-09-03.20:13:55.873 [http-nio-8091-exec-2] INFO  RaffleActivityController - 活动装配，数据预热，完成 activityId:101
24-09-03.20:14:00.005 [scheduling-1    ] INFO  UpdateActivitySkuStockJob - 定时任务，更新活动sku库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:00.027 [scheduling-1    ] INFO  UpdateAwardStockJob    - 定时任务，更新奖品消耗库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:00.029 [pool-7-thread-3 ] INFO  ShardingSphere-SQL     - Logic SQL: select topic,
               user_id,
               message,
               message_id
        from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) limit 10;;
24-09-03.20:14:00.029 [pool-7-thread-3 ] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional[org.apache.shardingsphere.sql.parser.sql.common.segment.dml.pagination.limit.LimitSegment@8f4d9aa], lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:00.029 [pool-7-thread-3 ] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:00.029 [pool-7-thread-3 ] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:02.702 [http-nio-8091-exec-3] INFO  RaffleActivityController - 活动抽奖 userId:lyt activityId:101
24-09-03.20:14:02.838 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order where activity_id = ? and user_id = ? and order_state = 'create'
24-09-03.20:14:02.838 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:02.838 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order_0 where activity_id = ? and user_id = ? and order_state = 'create' ::: [101, lyt]
24-09-03.20:14:02.897 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account where user_id = ? and activity_id = ?
24-09-03.20:14:02.897 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:02.898 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account_0 where user_id = ? and activity_id = ? ::: [lyt, 101]
24-09-03.20:14:02.935 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month
        where user_id = ?
          and activity_id = ?
          and `month` = ?;
24-09-03.20:14:02.935 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:02.935 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month_0
        where user_id = ?
          and activity_id = ?
          and `month` = ?; ::: [lyt, 101, 2024-09]
24-09-03.20:14:03.002 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:03.002 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:03.002 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:03.130 [http-nio-8091-exec-3] INFO  SnowflakeUUIDUtils     - 12位数字的UUID:183094232889
24-09-03.20:14:03.155 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0;
24-09-03.20:14:03.155 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:03.155 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_0 set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0; ::: [lyt, 101]
24-09-03.20:14:03.212 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_month
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0
24-09-03.20:14:03.212 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:03.212 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_month_0
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0 ::: [lyt, 101, 2024-09]
24-09-03.20:14:03.272 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: insert into raffle_activity_account_day(
            user_id, activity_id, day, day_count, day_count_surplus, create_time, update_time)
        values
            (?, ?, ?, ?, ?, now(), now())
24-09-03.20:14:03.272 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:03.273 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into raffle_activity_account_day_0(
            user_id, activity_id, day, day_count, day_count_surplus, create_time, update_time, id)
        values
            (?, ?, ?, ?, ?, now(), now(), ?) ::: [lyt, 101, 2024-09-03, 20, 19, 1037821986023649280]
24-09-03.20:14:03.310 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account
        set day_count_surplus = ?, update_time = now()
        where user_id = ? and activity_id = ?
24-09-03.20:14:03.310 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:03.310 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_0
        set day_count_surplus = ?, update_time = now()
        where user_id = ? and activity_id = ? ::: [19, lyt, 101]
24-09-03.20:14:03.349 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_raffle_order(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        )
        values(
                  ?, ?, ?, ?, ?, ?, ?, now(), now()
              )
24-09-03.20:14:03.349 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:03.349 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_raffle_order_0(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        , id)
        values(?, ?, ?, ?, ?, ?, ?, now(), now(), ?) ::: [lyt, 101, 测试, 100004, 183094232889, 2024-09-03 20:14:02.707, create, 1037821986359193601]
24-09-03.20:14:03.432 [http-nio-8091-exec-3] INFO  RaffleActivityController - 活动抽奖，创建订单 userId:lyt activityId:101 orderId:183094232889
24-09-03.20:14:03.543 [http-nio-8091-exec-3] INFO  DefaultLogicChain      - 抽奖责任链-默认处理 userId: lyt strategyId: 100004 ruleModel: rule_default awardId: 104
24-09-03.20:14:03.546 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ?
24-09-03.20:14:03.546 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:03.546 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ? ::: [100004, 104]
24-09-03.20:14:03.613 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: select
            tree_id,
            tree_name,
            tree_desc,
            tree_root_rule_key
        from rule_tree
        where tree_id = ?;
24-09-03.20:14:03.613 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:03.613 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select
            tree_id,
            tree_name,
            tree_desc,
            tree_root_rule_key
        from rule_tree
        where tree_id = ?; ::: [tree_lock]
24-09-03.20:14:03.633 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: select
            tree_id,
            rule_key,
            rule_desc,
            rule_value
        from rule_tree_node
        where tree_id = ?;
24-09-03.20:14:03.634 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:03.634 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select
            tree_id,
            rule_key,
            rule_desc,
            rule_value
        from rule_tree_node
        where tree_id = ?; ::: [tree_lock]
24-09-03.20:14:03.654 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: select
            tree_id,
            rule_node_from,
            rule_node_to,
            rule_limit_type,
            rule_limit_value
        from rule_tree_node_line
        where tree_id = ?;
24-09-03.20:14:03.654 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:03.654 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select
            tree_id,
            rule_node_from,
            rule_node_to,
            rule_limit_type,
            rule_limit_value
        from rule_tree_node_line
        where tree_id = ?; ::: [tree_lock]
24-09-03.20:14:03.706 [http-nio-8091-exec-3] INFO  RuleLockLogicTreeNode  - 规则过滤-次数锁 userId:lyt strategyId:100004 awardId:104
24-09-03.20:14:03.708 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: select activity_id
        from raffle_activity where strategy_id = ?;
24-09-03.20:14:03.708 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:03.708 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select activity_id
        from raffle_activity where strategy_id = ?; ::: [100004]
24-09-03.20:14:03.728 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:03.728 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:03.728 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:03.750 [http-nio-8091-exec-3] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_lock code:0001
24-09-03.20:14:03.750 [http-nio-8091-exec-3] INFO  RuleLuckAwardLogicTreeNode - 规则过滤-兜底奖品 userId:lyt strategyId:100004 awardId:104 ruleValue:100:1,100
24-09-03.20:14:03.751 [http-nio-8091-exec-3] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_luck_award code:0001
24-09-03.20:14:03.751 [http-nio-8091-exec-3] INFO  AbstractRaffleStrategy - 抽奖策略计算-规则树 lyt 100004 100 1,100
24-09-03.20:14:03.775 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: select strategy_id,
               award_id,
               award_title,
               award_subtitle,
               award_count,
               award_count_surplus,
               award_rate,
               sort
        from strategy_award
        where strategy_id = ?
        and award_id = ?
24-09-03.20:14:03.775 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:03.775 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select strategy_id,
               award_id,
               award_title,
               award_subtitle,
               award_count,
               award_count_surplus,
               award_rate,
               sort
        from strategy_award
        where strategy_id = ?
        and award_id = ? ::: [100004, 100]
24-09-03.20:14:03.823 [http-nio-8091-exec-3] INFO  SnowflakeUUIDUtils     - 11位数字的UUID:18309423318
24-09-03.20:14:03.974 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_award_record(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state) values(?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?);
24-09-03.20:14:03.974 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:03.974 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_award_record_0(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state, id) values(?, ?, ?, ?, ?, ?, ?, ?, ?); ::: [lyt, 101, 100004, 183094232889, 100, 随机积分, 2024-09-03 20:14:03.822, create, 1037821988934496256]
24-09-03.20:14:04.067 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        ) values (?,
                 ?,
                 ?,
                 ?,
                 ?);
24-09-03.20:14:04.067 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:04.067 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        , id) values (?, ?, ?, ?, ?, ?); ::: [send_award, lyt, {"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423318","timeStamp":"2024-09-03 20:14:03.823"}, 18309423318, create, 1037821989328760833]
24-09-03.20:14:04.157 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Logic SQL: update user_raffle_order set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create';
24-09-03.20:14:04.157 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:04.157 [http-nio-8091-exec-3] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update user_raffle_order_0 set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create'; ::: [lyt, 183094232889]
24-09-03.20:14:04.296 [pool-7-thread-4 ] INFO  EventPublisher         - 发送 MQ 消息 topic:send_award, message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423318","timeStamp":"2024-09-03 20:14:03.823"}
24-09-03.20:14:04.298 [pool-7-thread-4 ] INFO  ShardingSphere-SQL     - Logic SQL: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?;
24-09-03.20:14:04.298 [pool-7-thread-4 ] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:04.298 [pool-7-thread-4 ] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423318]
24-09-03.20:14:04.298 [pool-7-thread-4 ] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423318]
24-09-03.20:14:04.328 [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#1-1] INFO  SendAwardCustomer      - 监听用户奖品发送消息 topic:send_award message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423318","timeStamp":"2024-09-03 20:14:03.823"}
24-09-03.20:14:05.004 [scheduling-1    ] INFO  UpdateAwardStockJob    - 定时任务，更新奖品消耗库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:05.027 [scheduling-1    ] INFO  UpdateActivitySkuStockJob - 定时任务，更新活动sku库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:05.055 [pool-7-thread-5 ] INFO  ShardingSphere-SQL     - Logic SQL: select topic,
               user_id,
               message,
               message_id
        from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) limit 10;;
24-09-03.20:14:05.055 [pool-7-thread-5 ] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional[org.apache.shardingsphere.sql.parser.sql.common.segment.dml.pagination.limit.LimitSegment@8f4d9aa], lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:05.055 [pool-7-thread-5 ] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:05.055 [pool-7-thread-5 ] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:05.973 [http-nio-8091-exec-6] INFO  RaffleActivityController - 活动抽奖 userId:lyt activityId:101
24-09-03.20:14:05.995 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order where activity_id = ? and user_id = ? and order_state = 'create'
24-09-03.20:14:05.995 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:05.995 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order_0 where activity_id = ? and user_id = ? and order_state = 'create' ::: [101, lyt]
24-09-03.20:14:06.033 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account where user_id = ? and activity_id = ?
24-09-03.20:14:06.033 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:06.033 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account_0 where user_id = ? and activity_id = ? ::: [lyt, 101]
24-09-03.20:14:06.055 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month
        where user_id = ?
          and activity_id = ?
          and `month` = ?;
24-09-03.20:14:06.055 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:06.057 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month_0
        where user_id = ?
          and activity_id = ?
          and `month` = ?; ::: [lyt, 101, 2024-09]
24-09-03.20:14:06.078 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:06.078 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:06.078 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:06.124 [http-nio-8091-exec-6] INFO  SnowflakeUUIDUtils     - 12位数字的UUID:183094234145
24-09-03.20:14:06.125 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0;
24-09-03.20:14:06.125 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:06.125 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_0 set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0; ::: [lyt, 101]
24-09-03.20:14:06.182 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_month
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0
24-09-03.20:14:06.182 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:06.182 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_month_0
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0 ::: [lyt, 101, 2024-09]
24-09-03.20:14:06.228 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_day
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0
24-09-03.20:14:06.228 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:06.228 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_day_0
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0 ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:06.266 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_raffle_order(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        )
        values(
                  ?, ?, ?, ?, ?, ?, ?, now(), now()
              )
24-09-03.20:14:06.266 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:06.266 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_raffle_order_0(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        , id)
        values(?, ?, ?, ?, ?, ?, ?, now(), now(), ?) ::: [lyt, 101, 测试, 100004, 183094234145, 2024-09-03 20:14:05.973, create, 1037821998593978368]
24-09-03.20:14:06.344 [http-nio-8091-exec-6] INFO  RaffleActivityController - 活动抽奖，创建订单 userId:lyt activityId:101 orderId:183094234145
24-09-03.20:14:06.411 [http-nio-8091-exec-6] INFO  DefaultLogicChain      - 抽奖责任链-默认处理 userId: lyt strategyId: 100004 ruleModel: rule_default awardId: 102
24-09-03.20:14:06.412 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ?
24-09-03.20:14:06.412 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:06.412 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ? ::: [100004, 102]
24-09-03.20:14:06.498 [http-nio-8091-exec-6] INFO  RuleLockLogicTreeNode  - 规则过滤-次数锁 userId:lyt strategyId:100004 awardId:102
24-09-03.20:14:06.500 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: select activity_id
        from raffle_activity where strategy_id = ?;
24-09-03.20:14:06.500 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:06.500 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select activity_id
        from raffle_activity where strategy_id = ?; ::: [100004]
24-09-03.20:14:06.519 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:06.519 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:06.519 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:06.540 [http-nio-8091-exec-6] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_lock code:0001
24-09-03.20:14:06.540 [http-nio-8091-exec-6] INFO  RuleLuckAwardLogicTreeNode - 规则过滤-兜底奖品 userId:lyt strategyId:100004 awardId:102 ruleValue:100:1,100
24-09-03.20:14:06.540 [http-nio-8091-exec-6] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_luck_award code:0001
24-09-03.20:14:06.540 [http-nio-8091-exec-6] INFO  AbstractRaffleStrategy - 抽奖策略计算-规则树 lyt 100004 100 1,100
24-09-03.20:14:06.564 [http-nio-8091-exec-6] INFO  SnowflakeUUIDUtils     - 11位数字的UUID:18309423433
24-09-03.20:14:06.566 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_award_record(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state) values(?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?);
24-09-03.20:14:06.567 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:06.567 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_award_record_0(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state, id) values(?, ?, ?, ?, ?, ?, ?, ?, ?); ::: [lyt, 101, 100004, 183094234145, 100, 随机积分, 2024-09-03 20:14:06.564, create, 1037821999856463873]
24-09-03.20:14:06.629 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        ) values (?,
                 ?,
                 ?,
                 ?,
                 ?);
24-09-03.20:14:06.629 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:06.629 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        , id) values (?, ?, ?, ?, ?, ?); ::: [send_award, lyt, {"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423433","timeStamp":"2024-09-03 20:14:06.564"}, 18309423433, create, 1037822000116510720]
24-09-03.20:14:06.702 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Logic SQL: update user_raffle_order set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create';
24-09-03.20:14:06.702 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:06.702 [http-nio-8091-exec-6] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update user_raffle_order_0 set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create'; ::: [lyt, 183094234145]
24-09-03.20:14:06.822 [pool-7-thread-6 ] INFO  EventPublisher         - 发送 MQ 消息 topic:send_award, message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423433","timeStamp":"2024-09-03 20:14:06.564"}
24-09-03.20:14:06.822 [pool-7-thread-6 ] INFO  ShardingSphere-SQL     - Logic SQL: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?;
24-09-03.20:14:06.822 [pool-7-thread-6 ] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:06.822 [pool-7-thread-6 ] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423433]
24-09-03.20:14:06.822 [pool-7-thread-6 ] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423433]
24-09-03.20:14:06.849 [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#1-1] INFO  SendAwardCustomer      - 监听用户奖品发送消息 topic:send_award message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423433","timeStamp":"2024-09-03 20:14:06.564"}
24-09-03.20:14:07.837 [http-nio-8091-exec-5] INFO  RaffleActivityController - 活动抽奖 userId:lyt activityId:101
24-09-03.20:14:07.857 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order where activity_id = ? and user_id = ? and order_state = 'create'
24-09-03.20:14:07.857 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:07.857 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order_0 where activity_id = ? and user_id = ? and order_state = 'create' ::: [101, lyt]
24-09-03.20:14:07.896 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account where user_id = ? and activity_id = ?
24-09-03.20:14:07.896 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:07.896 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account_0 where user_id = ? and activity_id = ? ::: [lyt, 101]
24-09-03.20:14:07.917 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month
        where user_id = ?
          and activity_id = ?
          and `month` = ?;
24-09-03.20:14:07.917 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:07.917 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month_0
        where user_id = ?
          and activity_id = ?
          and `month` = ?; ::: [lyt, 101, 2024-09]
24-09-03.20:14:07.939 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:07.939 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:07.939 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:07.981 [http-nio-8091-exec-5] INFO  SnowflakeUUIDUtils     - 12位数字的UUID:183094234924
24-09-03.20:14:07.982 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0;
24-09-03.20:14:07.982 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:07.982 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_0 set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0; ::: [lyt, 101]
24-09-03.20:14:08.037 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_month
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0
24-09-03.20:14:08.038 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:08.038 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_month_0
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0 ::: [lyt, 101, 2024-09]
24-09-03.20:14:08.077 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_day
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0
24-09-03.20:14:08.077 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:08.077 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_day_0
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0 ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:08.114 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_raffle_order(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        )
        values(
                  ?, ?, ?, ?, ?, ?, ?, now(), now()
              )
24-09-03.20:14:08.114 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:08.114 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_raffle_order_0(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        , id)
        values(?, ?, ?, ?, ?, ?, ?, now(), now(), ?) ::: [lyt, 101, 测试, 100004, 183094234924, 2024-09-03 20:14:07.837, create, 1037822006345052161]
24-09-03.20:14:08.190 [http-nio-8091-exec-5] INFO  RaffleActivityController - 活动抽奖，创建订单 userId:lyt activityId:101 orderId:183094234924
24-09-03.20:14:08.257 [http-nio-8091-exec-5] INFO  DefaultLogicChain      - 抽奖责任链-默认处理 userId: lyt strategyId: 100004 ruleModel: rule_default awardId: 102
24-09-03.20:14:08.258 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ?
24-09-03.20:14:08.258 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:08.258 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ? ::: [100004, 102]
24-09-03.20:14:08.316 [http-nio-8091-exec-5] INFO  RuleLockLogicTreeNode  - 规则过滤-次数锁 userId:lyt strategyId:100004 awardId:102
24-09-03.20:14:08.317 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: select activity_id
        from raffle_activity where strategy_id = ?;
24-09-03.20:14:08.317 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:08.317 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select activity_id
        from raffle_activity where strategy_id = ?; ::: [100004]
24-09-03.20:14:08.338 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:08.338 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:08.338 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:08.358 [http-nio-8091-exec-5] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_lock code:0001
24-09-03.20:14:08.359 [http-nio-8091-exec-5] INFO  RuleLuckAwardLogicTreeNode - 规则过滤-兜底奖品 userId:lyt strategyId:100004 awardId:102 ruleValue:100:1,100
24-09-03.20:14:08.359 [http-nio-8091-exec-5] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_luck_award code:0001
24-09-03.20:14:08.359 [http-nio-8091-exec-5] INFO  AbstractRaffleStrategy - 抽奖策略计算-规则树 lyt 100004 100 1,100
24-09-03.20:14:08.382 [http-nio-8091-exec-5] INFO  SnowflakeUUIDUtils     - 11位数字的UUID:18309423509
24-09-03.20:14:08.383 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_award_record(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state) values(?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?);
24-09-03.20:14:08.383 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:08.383 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_award_record_0(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state, id) values(?, ?, ?, ?, ?, ?, ?, ?, ?); ::: [lyt, 101, 100004, 183094234924, 100, 随机积分, 2024-09-03 20:14:08.381, create, 1037822007477514240]
24-09-03.20:14:08.438 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        ) values (?,
                 ?,
                 ?,
                 ?,
                 ?);
24-09-03.20:14:08.439 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:08.439 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        , id) values (?, ?, ?, ?, ?, ?); ::: [send_award, lyt, {"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423509","timeStamp":"2024-09-03 20:14:08.382"}, 18309423509, create, 1037822007708200961]
24-09-03.20:14:08.494 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Logic SQL: update user_raffle_order set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create';
24-09-03.20:14:08.494 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:08.494 [http-nio-8091-exec-5] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update user_raffle_order_0 set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create'; ::: [lyt, 183094234924]
24-09-03.20:14:08.609 [pool-7-thread-7 ] INFO  EventPublisher         - 发送 MQ 消息 topic:send_award, message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423509","timeStamp":"2024-09-03 20:14:08.382"}
24-09-03.20:14:08.611 [pool-7-thread-7 ] INFO  ShardingSphere-SQL     - Logic SQL: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?;
24-09-03.20:14:08.611 [pool-7-thread-7 ] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:08.611 [pool-7-thread-7 ] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423509]
24-09-03.20:14:08.611 [pool-7-thread-7 ] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423509]
24-09-03.20:14:08.629 [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#1-1] INFO  SendAwardCustomer      - 监听用户奖品发送消息 topic:send_award message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423509","timeStamp":"2024-09-03 20:14:08.382"}
24-09-03.20:14:09.369 [http-nio-8091-exec-8] INFO  RaffleActivityController - 活动抽奖 userId:lyt activityId:101
24-09-03.20:14:09.401 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order where activity_id = ? and user_id = ? and order_state = 'create'
24-09-03.20:14:09.401 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:09.401 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order_0 where activity_id = ? and user_id = ? and order_state = 'create' ::: [101, lyt]
24-09-03.20:14:09.457 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account where user_id = ? and activity_id = ?
24-09-03.20:14:09.457 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:09.457 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account_0 where user_id = ? and activity_id = ? ::: [lyt, 101]
24-09-03.20:14:09.483 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month
        where user_id = ?
          and activity_id = ?
          and `month` = ?;
24-09-03.20:14:09.483 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:09.483 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month_0
        where user_id = ?
          and activity_id = ?
          and `month` = ?; ::: [lyt, 101, 2024-09]
24-09-03.20:14:09.518 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:09.518 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:09.518 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:09.575 [http-nio-8091-exec-8] INFO  SnowflakeUUIDUtils     - 12位数字的UUID:183094235593
24-09-03.20:14:09.577 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0;
24-09-03.20:14:09.577 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:09.577 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_0 set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0; ::: [lyt, 101]
24-09-03.20:14:09.649 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_month
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0
24-09-03.20:14:09.649 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:09.649 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_month_0
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0 ::: [lyt, 101, 2024-09]
24-09-03.20:14:09.695 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_day
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0
24-09-03.20:14:09.695 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:09.695 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_day_0
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0 ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:09.734 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_raffle_order(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        )
        values(
                  ?, ?, ?, ?, ?, ?, ?, now(), now()
              )
24-09-03.20:14:09.734 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:09.734 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_raffle_order_0(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        , id)
        values(?, ?, ?, ?, ?, ?, ?, now(), now(), ?) ::: [lyt, 101, 测试, 100004, 183094235593, 2024-09-03 20:14:09.369, create, 1037822013139824640]
24-09-03.20:14:09.822 [http-nio-8091-exec-8] INFO  RaffleActivityController - 活动抽奖，创建订单 userId:lyt activityId:101 orderId:183094235593
24-09-03.20:14:09.886 [http-nio-8091-exec-8] INFO  DefaultLogicChain      - 抽奖责任链-默认处理 userId: lyt strategyId: 100004 ruleModel: rule_default awardId: 102
24-09-03.20:14:09.887 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ?
24-09-03.20:14:09.887 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:09.887 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ? ::: [100004, 102]
24-09-03.20:14:09.953 [http-nio-8091-exec-8] INFO  RuleLockLogicTreeNode  - 规则过滤-次数锁 userId:lyt strategyId:100004 awardId:102
24-09-03.20:14:09.953 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: select activity_id
        from raffle_activity where strategy_id = ?;
24-09-03.20:14:09.953 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:09.953 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select activity_id
        from raffle_activity where strategy_id = ?; ::: [100004]
24-09-03.20:14:09.973 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:09.973 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:09.973 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:09.993 [http-nio-8091-exec-8] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_lock code:0001
24-09-03.20:14:09.993 [http-nio-8091-exec-8] INFO  RuleLuckAwardLogicTreeNode - 规则过滤-兜底奖品 userId:lyt strategyId:100004 awardId:102 ruleValue:100:1,100
24-09-03.20:14:09.993 [http-nio-8091-exec-8] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_luck_award code:0001
24-09-03.20:14:09.993 [http-nio-8091-exec-8] INFO  AbstractRaffleStrategy - 抽奖策略计算-规则树 lyt 100004 100 1,100
24-09-03.20:14:10.014 [scheduling-1    ] INFO  UpdateActivitySkuStockJob - 定时任务，更新活动sku库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:10.017 [http-nio-8091-exec-8] INFO  SnowflakeUUIDUtils     - 11位数字的UUID:18309423577
24-09-03.20:14:10.018 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_award_record(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state) values(?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?);
24-09-03.20:14:10.018 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:10.018 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_award_record_0(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state, id) values(?, ?, ?, ?, ?, ?, ?, ?, ?); ::: [lyt, 101, 100004, 183094235593, 100, 随机积分, 2024-09-03 20:14:10.017, create, 1037822014335201281]
24-09-03.20:14:10.061 [scheduling-1    ] INFO  UpdateAwardStockJob    - 定时任务，更新奖品消耗库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:10.062 [pool-7-thread-8 ] INFO  ShardingSphere-SQL     - Logic SQL: select topic,
               user_id,
               message,
               message_id
        from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) limit 10;;
24-09-03.20:14:10.062 [pool-7-thread-8 ] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional[org.apache.shardingsphere.sql.parser.sql.common.segment.dml.pagination.limit.LimitSegment@8f4d9aa], lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:10.062 [pool-7-thread-8 ] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:10.062 [pool-7-thread-8 ] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:10.116 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        ) values (?,
                 ?,
                 ?,
                 ?,
                 ?);
24-09-03.20:14:10.116 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:10.116 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        , id) values (?, ?, ?, ?, ?, ?); ::: [send_award, lyt, {"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423577","timeStamp":"2024-09-03 20:14:10.017"}, 18309423577, create, 1037822014746243072]
24-09-03.20:14:10.191 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Logic SQL: update user_raffle_order set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create';
24-09-03.20:14:10.191 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:10.191 [http-nio-8091-exec-8] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update user_raffle_order_0 set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create'; ::: [lyt, 183094235593]
24-09-03.20:14:10.307 [pool-7-thread-9 ] INFO  EventPublisher         - 发送 MQ 消息 topic:send_award, message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423577","timeStamp":"2024-09-03 20:14:10.017"}
24-09-03.20:14:10.307 [pool-7-thread-9 ] INFO  ShardingSphere-SQL     - Logic SQL: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?;
24-09-03.20:14:10.307 [pool-7-thread-9 ] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:10.307 [pool-7-thread-9 ] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423577]
24-09-03.20:14:10.307 [pool-7-thread-9 ] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423577]
24-09-03.20:14:10.326 [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#1-1] INFO  SendAwardCustomer      - 监听用户奖品发送消息 topic:send_award message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423577","timeStamp":"2024-09-03 20:14:10.017"}
24-09-03.20:14:11.146 [http-nio-8091-exec-7] INFO  RaffleActivityController - 活动抽奖 userId:lyt activityId:101
24-09-03.20:14:11.172 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order where activity_id = ? and user_id = ? and order_state = 'create'
24-09-03.20:14:11.172 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:11.172 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order_0 where activity_id = ? and user_id = ? and order_state = 'create' ::: [101, lyt]
24-09-03.20:14:11.209 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account where user_id = ? and activity_id = ?
24-09-03.20:14:11.209 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:11.209 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account_0 where user_id = ? and activity_id = ? ::: [lyt, 101]
24-09-03.20:14:11.230 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month
        where user_id = ?
          and activity_id = ?
          and `month` = ?;
24-09-03.20:14:11.230 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:11.230 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month_0
        where user_id = ?
          and activity_id = ?
          and `month` = ?; ::: [lyt, 101, 2024-09]
24-09-03.20:14:11.250 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:11.250 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:11.250 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:11.297 [http-nio-8091-exec-7] INFO  SnowflakeUUIDUtils     - 12位数字的UUID:183094236315
24-09-03.20:14:11.299 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0;
24-09-03.20:14:11.299 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:11.299 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_0 set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0; ::: [lyt, 101]
24-09-03.20:14:11.353 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_month
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0
24-09-03.20:14:11.353 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:11.353 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_month_0
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0 ::: [lyt, 101, 2024-09]
24-09-03.20:14:11.391 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_day
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0
24-09-03.20:14:11.391 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:11.391 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_day_0
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0 ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:11.429 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_raffle_order(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        )
        values(
                  ?, ?, ?, ?, ?, ?, ?, now(), now()
              )
24-09-03.20:14:11.429 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:11.429 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_raffle_order_0(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        , id)
        values(?, ?, ?, ?, ?, ?, ?, now(), now(), ?) ::: [lyt, 101, 测试, 100004, 183094236315, 2024-09-03 20:14:11.146, create, 1037822020249169921]
24-09-03.20:14:11.504 [http-nio-8091-exec-7] INFO  RaffleActivityController - 活动抽奖，创建订单 userId:lyt activityId:101 orderId:183094236315
24-09-03.20:14:11.589 [http-nio-8091-exec-7] INFO  DefaultLogicChain      - 抽奖责任链-默认处理 userId: lyt strategyId: 100004 ruleModel: rule_default awardId: 104
24-09-03.20:14:11.590 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ?
24-09-03.20:14:11.590 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:11.590 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ? ::: [100004, 104]
24-09-03.20:14:11.649 [http-nio-8091-exec-7] INFO  RuleLockLogicTreeNode  - 规则过滤-次数锁 userId:lyt strategyId:100004 awardId:104
24-09-03.20:14:11.650 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: select activity_id
        from raffle_activity where strategy_id = ?;
24-09-03.20:14:11.650 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:11.650 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select activity_id
        from raffle_activity where strategy_id = ?; ::: [100004]
24-09-03.20:14:11.669 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:11.669 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:11.669 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:11.688 [http-nio-8091-exec-7] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_lock code:0001
24-09-03.20:14:11.688 [http-nio-8091-exec-7] INFO  RuleLuckAwardLogicTreeNode - 规则过滤-兜底奖品 userId:lyt strategyId:100004 awardId:104 ruleValue:100:1,100
24-09-03.20:14:11.688 [http-nio-8091-exec-7] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_luck_award code:0001
24-09-03.20:14:11.688 [http-nio-8091-exec-7] INFO  AbstractRaffleStrategy - 抽奖策略计算-规则树 lyt 100004 100 1,100
24-09-03.20:14:11.714 [http-nio-8091-exec-7] INFO  SnowflakeUUIDUtils     - 11位数字的UUID:18309423649
24-09-03.20:14:11.715 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_award_record(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state) values(?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?);
24-09-03.20:14:11.715 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:11.716 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_award_record_0(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state, id) values(?, ?, ?, ?, ?, ?, ?, ?, ?); ::: [lyt, 101, 100004, 183094236315, 100, 随机积分, 2024-09-03 20:14:11.714, create, 1037822021452935168]
24-09-03.20:14:11.771 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        ) values (?,
                 ?,
                 ?,
                 ?,
                 ?);
24-09-03.20:14:11.771 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:11.771 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        , id) values (?, ?, ?, ?, ?, ?); ::: [send_award, lyt, {"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423649","timeStamp":"2024-09-03 20:14:11.714"}, 18309423649, create, 1037822021687816193]
24-09-03.20:14:11.826 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Logic SQL: update user_raffle_order set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create';
24-09-03.20:14:11.826 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:11.826 [http-nio-8091-exec-7] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update user_raffle_order_0 set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create'; ::: [lyt, 183094236315]
24-09-03.20:14:11.942 [pool-7-thread-10] INFO  EventPublisher         - 发送 MQ 消息 topic:send_award, message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423649","timeStamp":"2024-09-03 20:14:11.714"}
24-09-03.20:14:11.943 [pool-7-thread-10] INFO  ShardingSphere-SQL     - Logic SQL: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?;
24-09-03.20:14:11.943 [pool-7-thread-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:11.943 [pool-7-thread-10] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423649]
24-09-03.20:14:11.943 [pool-7-thread-10] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423649]
24-09-03.20:14:11.961 [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#1-1] INFO  SendAwardCustomer      - 监听用户奖品发送消息 topic:send_award message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423649","timeStamp":"2024-09-03 20:14:11.714"}
24-09-03.20:14:13.195 [http-nio-8091-exec-4] INFO  RaffleActivityController - 活动抽奖 userId:lyt activityId:101
24-09-03.20:14:13.217 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order where activity_id = ? and user_id = ? and order_state = 'create'
24-09-03.20:14:13.217 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:13.217 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order_0 where activity_id = ? and user_id = ? and order_state = 'create' ::: [101, lyt]
24-09-03.20:14:13.255 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account where user_id = ? and activity_id = ?
24-09-03.20:14:13.255 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:13.255 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account_0 where user_id = ? and activity_id = ? ::: [lyt, 101]
24-09-03.20:14:13.276 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month
        where user_id = ?
          and activity_id = ?
          and `month` = ?;
24-09-03.20:14:13.276 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:13.276 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month_0
        where user_id = ?
          and activity_id = ?
          and `month` = ?; ::: [lyt, 101, 2024-09]
24-09-03.20:14:13.298 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:13.298 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:13.298 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:13.341 [http-nio-8091-exec-4] INFO  SnowflakeUUIDUtils     - 12位数字的UUID:183094237172
24-09-03.20:14:13.342 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0;
24-09-03.20:14:13.342 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:13.342 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_0 set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0; ::: [lyt, 101]
24-09-03.20:14:13.399 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_month
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0
24-09-03.20:14:13.399 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:13.399 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_month_0
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0 ::: [lyt, 101, 2024-09]
24-09-03.20:14:13.436 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_day
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0
24-09-03.20:14:13.436 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:13.436 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_day_0
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0 ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:13.473 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_raffle_order(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        )
        values(
                  ?, ?, ?, ?, ?, ?, ?, now(), now()
              )
24-09-03.20:14:13.473 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:13.473 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_raffle_order_0(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        , id)
        values(?, ?, ?, ?, ?, ?, ?, now(), now(), ?) ::: [lyt, 101, 测试, 100004, 183094237172, 2024-09-03 20:14:13.195, create, 1037822028822327296]
24-09-03.20:14:13.548 [http-nio-8091-exec-4] INFO  RaffleActivityController - 活动抽奖，创建订单 userId:lyt activityId:101 orderId:183094237172
24-09-03.20:14:13.613 [http-nio-8091-exec-4] INFO  DefaultLogicChain      - 抽奖责任链-默认处理 userId: lyt strategyId: 100004 ruleModel: rule_default awardId: 101
24-09-03.20:14:13.615 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ?
24-09-03.20:14:13.615 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:13.615 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ? ::: [100004, 101]
24-09-03.20:14:13.670 [http-nio-8091-exec-4] INFO  RuleLockLogicTreeNode  - 规则过滤-次数锁 userId:lyt strategyId:100004 awardId:101
24-09-03.20:14:13.671 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: select activity_id
        from raffle_activity where strategy_id = ?;
24-09-03.20:14:13.671 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:13.671 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select activity_id
        from raffle_activity where strategy_id = ?; ::: [100004]
24-09-03.20:14:13.690 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:13.690 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:13.690 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:13.709 [http-nio-8091-exec-4] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_lock code:0001
24-09-03.20:14:13.709 [http-nio-8091-exec-4] INFO  RuleLuckAwardLogicTreeNode - 规则过滤-兜底奖品 userId:lyt strategyId:100004 awardId:101 ruleValue:100:1,100
24-09-03.20:14:13.709 [http-nio-8091-exec-4] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_luck_award code:0001
24-09-03.20:14:13.709 [http-nio-8091-exec-4] INFO  AbstractRaffleStrategy - 抽奖策略计算-规则树 lyt 100004 100 1,100
24-09-03.20:14:13.731 [http-nio-8091-exec-4] INFO  SnowflakeUUIDUtils     - 11位数字的UUID:18309423733
24-09-03.20:14:13.732 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_award_record(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state) values(?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?);
24-09-03.20:14:13.732 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:13.732 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_award_record_0(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state, id) values(?, ?, ?, ?, ?, ?, ?, ?, ?); ::: [lyt, 101, 100004, 183094237172, 100, 随机积分, 2024-09-03 20:14:13.731, create, 1037822029912846337]
24-09-03.20:14:13.787 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        ) values (?,
                 ?,
                 ?,
                 ?,
                 ?);
24-09-03.20:14:13.787 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:13.787 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        , id) values (?, ?, ?, ?, ?, ?); ::: [send_award, lyt, {"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423733","timeStamp":"2024-09-03 20:14:13.731"}, 18309423733, create, 1037822030143533056]
24-09-03.20:14:13.842 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Logic SQL: update user_raffle_order set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create';
24-09-03.20:14:13.842 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:13.842 [http-nio-8091-exec-4] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update user_raffle_order_0 set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create'; ::: [lyt, 183094237172]
24-09-03.20:14:13.962 [pool-7-thread-11] INFO  EventPublisher         - 发送 MQ 消息 topic:send_award, message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423733","timeStamp":"2024-09-03 20:14:13.731"}
24-09-03.20:14:13.963 [pool-7-thread-11] INFO  ShardingSphere-SQL     - Logic SQL: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?;
24-09-03.20:14:13.963 [pool-7-thread-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:13.963 [pool-7-thread-11] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423733]
24-09-03.20:14:13.963 [pool-7-thread-11] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423733]
24-09-03.20:14:13.981 [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#1-1] INFO  SendAwardCustomer      - 监听用户奖品发送消息 topic:send_award message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423733","timeStamp":"2024-09-03 20:14:13.731"}
24-09-03.20:14:14.842 [http-nio-8091-exec-9] INFO  RaffleActivityController - 活动抽奖 userId:lyt activityId:101
24-09-03.20:14:14.862 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order where activity_id = ? and user_id = ? and order_state = 'create'
24-09-03.20:14:14.862 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:14.862 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order_0 where activity_id = ? and user_id = ? and order_state = 'create' ::: [101, lyt]
24-09-03.20:14:14.900 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account where user_id = ? and activity_id = ?
24-09-03.20:14:14.900 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:14.900 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account_0 where user_id = ? and activity_id = ? ::: [lyt, 101]
24-09-03.20:14:14.921 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month
        where user_id = ?
          and activity_id = ?
          and `month` = ?;
24-09-03.20:14:14.921 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:14.921 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month_0
        where user_id = ?
          and activity_id = ?
          and `month` = ?; ::: [lyt, 101, 2024-09]
24-09-03.20:14:14.941 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:14.941 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:14.941 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:14.983 [http-nio-8091-exec-9] INFO  SnowflakeUUIDUtils     - 12位数字的UUID:183094237861
24-09-03.20:14:14.985 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0;
24-09-03.20:14:14.985 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:14.985 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_0 set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0; ::: [lyt, 101]
24-09-03.20:14:15.002 [scheduling-1    ] INFO  UpdateAwardStockJob    - 定时任务，更新奖品消耗库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:15.027 [scheduling-1    ] INFO  UpdateActivitySkuStockJob - 定时任务，更新活动sku库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:15.041 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_month
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0
24-09-03.20:14:15.041 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:15.041 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_month_0
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0 ::: [lyt, 101, 2024-09]
24-09-03.20:14:15.047 [pool-7-thread-12] INFO  ShardingSphere-SQL     - Logic SQL: select topic,
               user_id,
               message,
               message_id
        from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) limit 10;;
24-09-03.20:14:15.048 [pool-7-thread-12] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional[org.apache.shardingsphere.sql.parser.sql.common.segment.dml.pagination.limit.LimitSegment@8f4d9aa], lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:15.048 [pool-7-thread-12] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:15.048 [pool-7-thread-12] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:15.079 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_day
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0
24-09-03.20:14:15.079 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:15.079 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_day_0
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0 ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:15.132 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_raffle_order(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        )
        values(
                  ?, ?, ?, ?, ?, ?, ?, now(), now()
              )
24-09-03.20:14:15.132 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:15.132 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_raffle_order_0(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        , id)
        values(?, ?, ?, ?, ?, ?, ?, now(), now(), ?) ::: [lyt, 101, 测试, 100004, 183094237861, 2024-09-03 20:14:14.842, create, 1037822035780677633]
24-09-03.20:14:15.207 [http-nio-8091-exec-9] INFO  RaffleActivityController - 活动抽奖，创建订单 userId:lyt activityId:101 orderId:183094237861
24-09-03.20:14:15.268 [http-nio-8091-exec-9] INFO  DefaultLogicChain      - 抽奖责任链-默认处理 userId: lyt strategyId: 100004 ruleModel: rule_default awardId: 101
24-09-03.20:14:15.269 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ?
24-09-03.20:14:15.269 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:15.269 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ? ::: [100004, 101]
24-09-03.20:14:15.315 [http-nio-8091-exec-9] INFO  RuleLockLogicTreeNode  - 规则过滤-次数锁 userId:lyt strategyId:100004 awardId:101
24-09-03.20:14:15.316 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: select activity_id
        from raffle_activity where strategy_id = ?;
24-09-03.20:14:15.316 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:15.316 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select activity_id
        from raffle_activity where strategy_id = ?; ::: [100004]
24-09-03.20:14:15.336 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:15.336 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:15.336 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:15.356 [http-nio-8091-exec-9] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_lock code:0001
24-09-03.20:14:15.356 [http-nio-8091-exec-9] INFO  RuleLuckAwardLogicTreeNode - 规则过滤-兜底奖品 userId:lyt strategyId:100004 awardId:101 ruleValue:100:1,100
24-09-03.20:14:15.356 [http-nio-8091-exec-9] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_luck_award code:0001
24-09-03.20:14:15.356 [http-nio-8091-exec-9] INFO  AbstractRaffleStrategy - 抽奖策略计算-规则树 lyt 100004 100 1,100
24-09-03.20:14:15.375 [http-nio-8091-exec-9] INFO  SnowflakeUUIDUtils     - 11位数字的UUID:18309423802
24-09-03.20:14:15.376 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_award_record(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state) values(?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?);
24-09-03.20:14:15.376 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:15.376 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_award_record_0(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state, id) values(?, ?, ?, ?, ?, ?, ?, ?, ?); ::: [lyt, 101, 100004, 183094237861, 100, 随机积分, 2024-09-03 20:14:15.373, create, 1037822036804087808]
24-09-03.20:14:15.430 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        ) values (?,
                 ?,
                 ?,
                 ?,
                 ?);
24-09-03.20:14:15.430 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:15.430 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        , id) values (?, ?, ?, ?, ?, ?); ::: [send_award, lyt, {"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423802","timeStamp":"2024-09-03 20:14:15.375"}, 18309423802, create, 1037822037034774529]
24-09-03.20:14:15.486 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Logic SQL: update user_raffle_order set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create';
24-09-03.20:14:15.486 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:15.486 [http-nio-8091-exec-9] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update user_raffle_order_0 set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create'; ::: [lyt, 183094237861]
24-09-03.20:14:15.610 [pool-7-thread-13] INFO  EventPublisher         - 发送 MQ 消息 topic:send_award, message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423802","timeStamp":"2024-09-03 20:14:15.375"}
24-09-03.20:14:15.611 [pool-7-thread-13] INFO  ShardingSphere-SQL     - Logic SQL: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?;
24-09-03.20:14:15.611 [pool-7-thread-13] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:15.611 [pool-7-thread-13] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423802]
24-09-03.20:14:15.611 [pool-7-thread-13] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423802]
24-09-03.20:14:15.630 [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#1-1] INFO  SendAwardCustomer      - 监听用户奖品发送消息 topic:send_award message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423802","timeStamp":"2024-09-03 20:14:15.375"}
24-09-03.20:14:16.540 [http-nio-8091-exec-10] INFO  RaffleActivityController - 活动抽奖 userId:lyt activityId:101
24-09-03.20:14:16.564 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order where activity_id = ? and user_id = ? and order_state = 'create'
24-09-03.20:14:16.564 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:16.564 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order_0 where activity_id = ? and user_id = ? and order_state = 'create' ::: [101, lyt]
24-09-03.20:14:16.629 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account where user_id = ? and activity_id = ?
24-09-03.20:14:16.629 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:16.629 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account_0 where user_id = ? and activity_id = ? ::: [lyt, 101]
24-09-03.20:14:16.650 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month
        where user_id = ?
          and activity_id = ?
          and `month` = ?;
24-09-03.20:14:16.650 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:16.650 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month_0
        where user_id = ?
          and activity_id = ?
          and `month` = ?; ::: [lyt, 101, 2024-09]
24-09-03.20:14:16.670 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:16.670 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:16.670 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:16.709 [http-nio-8091-exec-10] INFO  SnowflakeUUIDUtils     - 12位数字的UUID:183094238585
24-09-03.20:14:16.709 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0;
24-09-03.20:14:16.709 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:16.710 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_0 set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0; ::: [lyt, 101]
24-09-03.20:14:16.770 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_month
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0
24-09-03.20:14:16.770 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:16.770 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_month_0
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0 ::: [lyt, 101, 2024-09]
24-09-03.20:14:16.812 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_day
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0
24-09-03.20:14:16.812 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:16.812 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_day_0
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0 ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:16.850 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_raffle_order(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        )
        values(
                  ?, ?, ?, ?, ?, ?, ?, now(), now()
              )
24-09-03.20:14:16.850 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:16.850 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_raffle_order_0(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        , id)
        values(?, ?, ?, ?, ?, ?, ?, now(), now(), ?) ::: [lyt, 101, 测试, 100004, 183094238585, 2024-09-03 20:14:16.54, create, 1037822042986491904]
24-09-03.20:14:16.927 [http-nio-8091-exec-10] INFO  RaffleActivityController - 活动抽奖，创建订单 userId:lyt activityId:101 orderId:183094238585
24-09-03.20:14:16.992 [http-nio-8091-exec-10] INFO  DefaultLogicChain      - 抽奖责任链-默认处理 userId: lyt strategyId: 100004 ruleModel: rule_default awardId: 100
24-09-03.20:14:16.993 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ?
24-09-03.20:14:16.993 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:16.993 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ? ::: [100004, 100]
24-09-03.20:14:17.052 [http-nio-8091-exec-10] INFO  RuleLockLogicTreeNode  - 规则过滤-次数锁 userId:lyt strategyId:100004 awardId:100
24-09-03.20:14:17.053 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: select activity_id
        from raffle_activity where strategy_id = ?;
24-09-03.20:14:17.053 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:17.053 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select activity_id
        from raffle_activity where strategy_id = ?; ::: [100004]
24-09-03.20:14:17.072 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:17.072 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:17.072 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:17.092 [http-nio-8091-exec-10] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_lock code:0000
24-09-03.20:14:17.092 [http-nio-8091-exec-10] INFO  RuleStockLogicTreeNode - 规则过滤-库存扣减 userId:lyt strategyId:100004 awardId:100
24-09-03.20:14:17.131 [http-nio-8091-exec-10] INFO  RuleStockLogicTreeNode - 规则过滤-库存扣减-成功 userId:lyt strategyId:100004 awardId:100
24-09-03.20:14:17.193 [http-nio-8091-exec-10] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_stock code:0001
24-09-03.20:14:17.193 [http-nio-8091-exec-10] INFO  AbstractRaffleStrategy - 抽奖策略计算-规则树 lyt 100004 100 null
24-09-03.20:14:17.216 [http-nio-8091-exec-10] INFO  SnowflakeUUIDUtils     - 11位数字的UUID:18309423879
24-09-03.20:14:17.217 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_award_record(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state) values(?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?);
24-09-03.20:14:17.217 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:17.217 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_award_record_0(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state, id) values(?, ?, ?, ?, ?, ?, ?, ?, ?); ::: [lyt, 101, 100004, 183094238585, 100, 随机积分, 2024-09-03 20:14:17.216, create, 1037822044529995777]
24-09-03.20:14:17.272 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        ) values (?,
                 ?,
                 ?,
                 ?,
                 ?);
24-09-03.20:14:17.272 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:17.272 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        , id) values (?, ?, ?, ?, ?, ?); ::: [send_award, lyt, {"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423879","timeStamp":"2024-09-03 20:14:17.216"}, 18309423879, create, 1037822044760682496]
24-09-03.20:14:17.327 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Logic SQL: update user_raffle_order set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create';
24-09-03.20:14:17.327 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:17.327 [http-nio-8091-exec-10] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update user_raffle_order_0 set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create'; ::: [lyt, 183094238585]
24-09-03.20:14:17.443 [pool-7-thread-14] INFO  EventPublisher         - 发送 MQ 消息 topic:send_award, message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423879","timeStamp":"2024-09-03 20:14:17.216"}
24-09-03.20:14:17.445 [pool-7-thread-14] INFO  ShardingSphere-SQL     - Logic SQL: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?;
24-09-03.20:14:17.445 [pool-7-thread-14] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:17.445 [pool-7-thread-14] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423879]
24-09-03.20:14:17.445 [pool-7-thread-14] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423879]
24-09-03.20:14:17.461 [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#1-1] INFO  SendAwardCustomer      - 监听用户奖品发送消息 topic:send_award message:{"data":{"awardId":100,"awardTitle":"随机积分","userId":"lyt"},"id":"18309423879","timeStamp":"2024-09-03 20:14:17.216"}
24-09-03.20:14:18.381 [http-nio-8091-exec-11] INFO  RaffleActivityController - 活动抽奖 userId:lyt activityId:101
24-09-03.20:14:18.416 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order where activity_id = ? and user_id = ? and order_state = 'create'
24-09-03.20:14:18.416 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:18.416 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select activity_name,
               strategy_id,
               order_id,
               order_time,
               order_state
        from user_raffle_order_0 where activity_id = ? and user_id = ? and order_state = 'create' ::: [101, lyt]
24-09-03.20:14:18.474 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account where user_id = ? and activity_id = ?
24-09-03.20:14:18.474 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:18.474 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select total_count,
               total_count_surplus,
               day_count,
               day_count_surplus,
               month_count,
               month_count_surplus
        from raffle_activity_account_0 where user_id = ? and activity_id = ? ::: [lyt, 101]
24-09-03.20:14:18.494 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month
        where user_id = ?
          and activity_id = ?
          and `month` = ?;
24-09-03.20:14:18.494 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:18.494 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `month`,
               month_count,
               month_count_surplus
        from raffle_activity_account_month_0
        where user_id = ?
          and activity_id = ?
          and `month` = ?; ::: [lyt, 101, 2024-09]
24-09-03.20:14:18.515 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:18.515 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:18.515 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:18.561 [http-nio-8091-exec-11] INFO  SnowflakeUUIDUtils     - 12位数字的UUID:183094239362
24-09-03.20:14:18.562 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0;
24-09-03.20:14:18.562 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:18.562 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_0 set total_count_surplus = total_count_surplus - 1,
                                           day_count_surplus = day_count_surplus - 1,
                                           month_count_surplus = month_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ?
        and total_count_surplus > 0 and day_count_surplus > 0 and month_count_surplus > 0; ::: [lyt, 101]
24-09-03.20:14:18.628 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_month
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0
24-09-03.20:14:18.628 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:18.628 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_month_0
        set month_count_surplus = month_count_surplus - 1,update_time = now()
        where user_id = ? and activity_id = ?
        and `month` = ? and month_count_surplus > 0 ::: [lyt, 101, 2024-09]
24-09-03.20:14:18.680 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: update raffle_activity_account_day
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0
24-09-03.20:14:18.680 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:18.680 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update raffle_activity_account_day_0
        set day_count_surplus = day_count_surplus - 1, update_time = now()
        where user_id = ? and activity_id = ? and day = ? and day_count_surplus > 0 ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:18.720 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_raffle_order(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        )
        values(
                  ?, ?, ?, ?, ?, ?, ?, now(), now()
              )
24-09-03.20:14:18.720 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:18.720 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_raffle_order_0(
            user_id, activity_id, activity_name, strategy_id, order_id, order_time, order_state, create_time, update_time
        , id)
        values(?, ?, ?, ?, ?, ?, ?, now(), now(), ?) ::: [lyt, 101, 测试, 100004, 183094239362, 2024-09-03 20:14:18.381, create, 1037822050829840385]
24-09-03.20:14:18.797 [http-nio-8091-exec-11] INFO  RaffleActivityController - 活动抽奖，创建订单 userId:lyt activityId:101 orderId:183094239362
24-09-03.20:14:18.873 [http-nio-8091-exec-11] INFO  DefaultLogicChain      - 抽奖责任链-默认处理 userId: lyt strategyId: 100004 ruleModel: rule_default awardId: 104
24-09-03.20:14:18.873 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ?
24-09-03.20:14:18.874 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:18.874 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select rule_models
        from strategy_award
        where strategy_id = ?
          and award_id = ? ::: [100004, 104]
24-09-03.20:14:18.932 [http-nio-8091-exec-11] INFO  RuleLockLogicTreeNode  - 规则过滤-次数锁 userId:lyt strategyId:100004 awardId:104
24-09-03.20:14:18.932 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: select activity_id
        from raffle_activity where strategy_id = ?;
24-09-03.20:14:18.932 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:18.932 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select activity_id
        from raffle_activity where strategy_id = ?; ::: [100004]
24-09-03.20:14:18.952 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day
        where user_id = ?
          and activity_id = ?
          and `day` = ?;
24-09-03.20:14:18.952 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:18.952 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select user_id,
               activity_id,
               `day`,
               day_count,
               day_count_surplus
        from raffle_activity_account_day_0
        where user_id = ?
          and activity_id = ?
          and `day` = ?; ::: [lyt, 101, 2024-09-03]
24-09-03.20:14:18.971 [http-nio-8091-exec-11] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_lock code:0000
24-09-03.20:14:18.971 [http-nio-8091-exec-11] INFO  RuleStockLogicTreeNode - 规则过滤-库存扣减 userId:lyt strategyId:100004 awardId:104
24-09-03.20:14:19.011 [http-nio-8091-exec-11] INFO  RuleStockLogicTreeNode - 规则过滤-库存扣减-成功 userId:lyt strategyId:100004 awardId:104
24-09-03.20:14:19.037 [http-nio-8091-exec-11] INFO  DecisionTreeEngine     - 决策树引擎【规则树】treeId:tree_lock node:rule_stock code:0001
24-09-03.20:14:19.037 [http-nio-8091-exec-11] INFO  AbstractRaffleStrategy - 抽奖策略计算-规则树 lyt 100004 104 null
24-09-03.20:14:19.059 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: select strategy_id,
               award_id,
               award_title,
               award_subtitle,
               award_count,
               award_count_surplus,
               award_rate,
               sort
        from strategy_award
        where strategy_id = ?
        and award_id = ?
24-09-03.20:14:19.059 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:19.059 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select strategy_id,
               award_id,
               award_title,
               award_subtitle,
               award_count,
               award_count_surplus,
               award_rate,
               sort
        from strategy_award
        where strategy_id = ?
        and award_id = ? ::: [100004, 104]
24-09-03.20:14:19.098 [http-nio-8091-exec-11] INFO  SnowflakeUUIDUtils     - 11位数字的UUID:18309423958
24-09-03.20:14:19.100 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: insert into user_award_record(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state) values(?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?,
                                ?);
24-09-03.20:14:19.100 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:19.100 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: insert into user_award_record_0(user_id,
            activity_id,
            strategy_id,
            order_id,
            award_id,
            award_title,
            award_time,
            award_state, id) values(?, ?, ?, ?, ?, ?, ?, ?, ?); ::: [lyt, 101, 100004, 183094239362, 104, 增加5次抽奖机会, 2024-09-03 20:14:19.098, create, 1037822052423675904]
24-09-03.20:14:19.157 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        ) values (?,
                 ?,
                 ?,
                 ?,
                 ?);
24-09-03.20:14:19.157 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLInsertStatement(setAssignment=Optional.empty, onDuplicateKeyColumns=Optional.empty)
24-09-03.20:14:19.157 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: insert into task(
            topic,
            user_id,
            message,
            message_id,
            state
        , id) values (?, ?, ?, ?, ?, ?); ::: [send_award, lyt, {"data":{"awardId":104,"awardTitle":"增加5次抽奖机会","userId":"lyt"},"id":"18309423958","timeStamp":"2024-09-03 20:14:19.098"}, 18309423958, create, 1037822052662751233]
24-09-03.20:14:19.211 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Logic SQL: update user_raffle_order set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create';
24-09-03.20:14:19.211 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:19.211 [http-nio-8091-exec-11] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update user_raffle_order_0 set order_state = 'used',update_time = now()
                                              where user_id = ? and order_id = ? and order_state = 'create'; ::: [lyt, 183094239362]
24-09-03.20:14:19.328 [pool-7-thread-15] INFO  EventPublisher         - 发送 MQ 消息 topic:send_award, message:{"data":{"awardId":104,"awardTitle":"增加5次抽奖机会","userId":"lyt"},"id":"18309423958","timeStamp":"2024-09-03 20:14:19.098"}
24-09-03.20:14:19.328 [pool-7-thread-15] INFO  ShardingSphere-SQL     - Logic SQL: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?;
24-09-03.20:14:19.328 [pool-7-thread-15] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:19.328 [pool-7-thread-15] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423958]
24-09-03.20:14:19.328 [pool-7-thread-15] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: update task set state = 'completed', update_time = now()
        where user_id = ? and message_id = ?; ::: [lyt, 18309423958]
24-09-03.20:14:19.347 [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#1-1] INFO  SendAwardCustomer      - 监听用户奖品发送消息 topic:send_award message:{"data":{"awardId":104,"awardTitle":"增加5次抽奖机会","userId":"lyt"},"id":"18309423958","timeStamp":"2024-09-03 20:14:19.098"}
24-09-03.20:14:20.012 [scheduling-1    ] INFO  UpdateActivitySkuStockJob - 定时任务，更新活动sku库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:20.012 [pool-7-thread-16] INFO  ShardingSphere-SQL     - Logic SQL: select topic,
               user_id,
               message,
               message_id
        from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) limit 10;;
24-09-03.20:14:20.012 [pool-7-thread-16] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional[org.apache.shardingsphere.sql.parser.sql.common.segment.dml.pagination.limit.LimitSegment@8f4d9aa], lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:20.013 [pool-7-thread-16] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:20.013 [pool-7-thread-16] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:20.034 [scheduling-1    ] INFO  UpdateAwardStockJob    - 定时任务，更新奖品消耗库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:25.011 [scheduling-1    ] INFO  UpdateAwardStockJob    - 定时任务，更新奖品消耗库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:25.042 [scheduling-1    ] INFO  UpdateAwardStockJob    - 定时任务，更新奖品消耗库存 strategyId:100004 awardId:100
24-09-03.20:14:25.043 [scheduling-1    ] INFO  ShardingSphere-SQL     - Logic SQL: select award_count_surplus from strategy_award
        where strategy_id = ? and award_id = ?
24-09-03.20:14:25.043 [scheduling-1    ] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:25.043 [scheduling-1    ] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select award_count_surplus from strategy_award
        where strategy_id = ? and award_id = ? ::: [100004, 100]
24-09-03.20:14:25.082 [scheduling-1    ] INFO  ShardingSphere-SQL     - Logic SQL: update strategy_award set award_count_surplus = award_count_surplus - 1
        where strategy_id = ? and award_id = ?
24-09-03.20:14:25.082 [scheduling-1    ] INFO  ShardingSphere-SQL     - SQLStatement: MySQLUpdateStatement(orderBy=Optional.empty, limit=Optional.empty)
24-09-03.20:14:25.082 [scheduling-1    ] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: update strategy_award set award_count_surplus = award_count_surplus - 1
        where strategy_id = ? and award_id = ? ::: [100004, 100]
24-09-03.20:14:25.122 [scheduling-1    ] INFO  UpdateActivitySkuStockJob - 定时任务，更新活动sku库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:25.145 [pool-7-thread-17] INFO  ShardingSphere-SQL     - Logic SQL: select topic,
               user_id,
               message,
               message_id
        from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) limit 10;;
24-09-03.20:14:25.145 [pool-7-thread-17] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional[org.apache.shardingsphere.sql.parser.sql.common.segment.dml.pagination.limit.LimitSegment@8f4d9aa], lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:25.145 [pool-7-thread-17] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:25.145 [pool-7-thread-17] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:29.483 [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-2] INFO  SimpleMessageListenerContainer - Waiting for workers to finish.
24-09-03.20:14:29.504 [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#1-2] INFO  SimpleMessageListenerContainer - Waiting for workers to finish.
24-09-03.20:14:29.504 [SpringApplicationShutdownHook] INFO  QuartzScheduler        - Scheduler quartzScheduler_$_NON_CLUSTERED paused.
24-09-03.20:14:30.010 [scheduling-1    ] INFO  UpdateAwardStockJob    - 定时任务，更新奖品消耗库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:30.011 [pool-7-thread-18] INFO  ShardingSphere-SQL     - Logic SQL: select topic,
               user_id,
               message,
               message_id
        from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) limit 10;;
24-09-03.20:14:30.011 [pool-7-thread-18] INFO  ShardingSphere-SQL     - SQLStatement: MySQLSelectStatement(limit=Optional[org.apache.shardingsphere.sql.parser.sql.common.segment.dml.pagination.limit.LimitSegment@8f4d9aa], lock=Optional.empty, window=Optional.empty)
24-09-03.20:14:30.011 [pool-7-thread-18] INFO  ShardingSphere-SQL     - Actual SQL: ds0 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:30.011 [pool-7-thread-18] INFO  ShardingSphere-SQL     - Actual SQL: ds1 ::: select topic,
               user_id,
               message,
               message_id
, id AS ORDER_BY_DERIVED_0         from task where state = 'fail' or(state = 'create' and now() - update_time > 60000000000000) ORDER BY id ASC  limit 10;;
24-09-03.20:14:30.029 [scheduling-1    ] INFO  UpdateActivitySkuStockJob - 定时任务，更新活动sku库存【延迟队列获取，降低对数据库的更新频次，不要产生竞争】
24-09-03.20:14:30.271 [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-2] INFO  SimpleMessageListenerContainer - Successfully waited for workers to finish.
24-09-03.20:14:30.432 [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#1-2] INFO  SimpleMessageListenerContainer - Successfully waited for workers to finish.
24-09-03.20:14:30.808 [SpringApplicationShutdownHook] INFO  SchedulerFactoryBean   - Shutting down Quartz Scheduler
24-09-03.20:14:30.808 [SpringApplicationShutdownHook] INFO  QuartzScheduler        - Scheduler quartzScheduler_$_NON_CLUSTERED shutting down.
24-09-03.20:14:30.808 [SpringApplicationShutdownHook] INFO  QuartzScheduler        - Scheduler quartzScheduler_$_NON_CLUSTERED paused.
24-09-03.20:14:30.809 [SpringApplicationShutdownHook] INFO  QuartzScheduler        - Scheduler quartzScheduler_$_NON_CLUSTERED shutdown complete.
24-09-03.20:14:30.809 [SpringApplicationShutdownHook] INFO  SimpleMessageListenerContainer - Shutdown ignored - container is already stopped
24-09-03.20:14:30.809 [SpringApplicationShutdownHook] INFO  SimpleMessageListenerContainer - Shutdown ignored - container is already stopped
24-09-03.20:14:30.911 [SpringApplicationShutdownHook] INFO  HikariDataSource       - HikariPool-1 - Shutdown initiated...
24-09-03.20:14:30.920 [SpringApplicationShutdownHook] INFO  HikariDataSource       - HikariPool-1 - Shutdown completed.
24-09-03.20:14:30.920 [SpringApplicationShutdownHook] INFO  HikariDataSource       - HikariPool-2 - Shutdown initiated...
24-09-03.20:14:30.927 [SpringApplicationShutdownHook] INFO  HikariDataSource       - HikariPool-2 - Shutdown completed.
